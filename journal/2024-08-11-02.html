<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Another view of Rust&#x27;s lifetime - Comcx&#x27;s secret base</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././src/assets/custom.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Comcx&#x27;s secret base</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="another-view-of-rusts-lifetime"><a class="header" href="#another-view-of-rusts-lifetime">Another view of Rust's lifetime</a></h1>
<pre><code>@tag(programming) @tag(rust)
</code></pre>
<p>Compared with <em>Haskell</em>, Rust is different for its effect system and ownership system.
Inside ownership system, lifetime plays an important role on borrowing and safety.
Traditionally, people think about lifetime as some region of code, which is a little kind of vague.
Why not try to see lifetime as a kind of memory(dependency) reference?</p>
<h2 id="lifetime-as-scope"><a class="header" href="#lifetime-as-scope">Lifetime as scope?</a></h2>
<p><em>The Rust book</em> suggests viewing lifetime as scopes. Consider a simple example:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let r;                // ---------+-- 'a
                          //          |
    {                     //          |
        let x = 5;        // -+-- 'b  |
        r = &amp;x;           //  |       |
    }                     // -+       |
                          //          |
    println!("r: {r}");   //          |
}                         // ---------+</code></pre></pre>
<p>Since <code>x</code>'s lifetime <code>'b</code> is shorter than <code>r</code>'s <code>'a</code>, we cannot assign <code>&amp;x</code> to <code>r</code>.
However, this reason is rather imprecise.
If we simply remove the last <code>println!</code> line, this code just compile fine.:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let r;                // ---------+-- 'a
                          //          |
    {                     //          |
        let x = 5;        // -+-- 'b  |
        r = &amp;x;           //  |       |
    }                     // -+       |
}                         // ---------+</code></pre></pre>
<p>Why?</p>
<p>Even worse, lifetime can contain <em>holes</em>, where itâ€™s intermittently invalid between where it starts and where it ultimately ends. For example, let's change our previous code simply:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let i = 42;
    let mut r;                
    {
        let x = 5;        
        r = &amp;x;            // -------------+-- 'r
                           //              |
    }                      // -------------+

    r = &amp;i;                // -------------+-- 'r
    println!("r: {}", *r); //              |
}                          // -------------+</code></pre></pre>
<p>This time the code compiles. Surprise!
Why? why this code compiles fine?? If r's lifetime coprresponds to <code>x</code>'s reference, why <code>r</code> can br printed outside <code>x</code>'s scope now? There may exist holes in lifetime.</p>
<p>Apparently <em>scope</em> view is not correct. We need something better.</p>
<h2 id="lifetime-as-regions-of-code"><a class="header" href="#lifetime-as-regions-of-code">Lifetime as regions of code?</a></h2>
<p><em>Rustonomicon</em> the book suggests viewing lifetime as named regions of code.
Now our previous problems are solved, since <code>'r</code> spans only its valid data flow regions and the regions can contains arbitrary holes.</p>
<blockquote>
<p>Lifetime is named regions of code where the pointed data is valid.</p>
</blockquote>
<p>What about lifetime constraints like <code>'a: 'b</code>?</p>
<h2 id="lifetime-subtyping"><a class="header" href="#lifetime-subtyping">Lifetime subtyping</a></h2>
<p>Subtyping is really just a spectial relation just as other <em>trait</em>s can represent.
The only subtyping in rust is lifetime subtyping.</p>
<blockquote>
<p>if <code>'b</code> outlives <code>'a</code>, then <code>'b: 'a</code> and <code>&amp;'b T</code> is a subtype of <code>&amp;'a T</code>.</p>
</blockquote>
<p>Since <code>&amp;'b T</code> is a subtype of <code>&amp;'a T</code>, we can assign any <code>&amp;'b T</code> to <code>&amp;'a T</code>.
For example(again from <em>the rust book</em>):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn longer&lt;'a&gt;(s1: &amp;'a str, s2: &amp;'a str) -&gt; &amp;'a str {
    if s1.len() &gt; s2.len() {
        s1
    } else {
        s2
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Actually, this code cannot compile without lifetime subtyping. It's equivalent to this code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn longer&lt;'a, 'b, 'c&gt;(s1: &amp;'a str, s2: &amp;'b str) -&gt; &amp;'c str 
where
    'a: 'c,
    'b: 'c,
{
    if s1.len() &gt; s2.len() {
        s1
    } else {
        s2
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Automatic subtyping is only a fancy and convenient way to expression this relationship.</p>
<h2 id="lifetime-as-memory-references"><a class="header" href="#lifetime-as-memory-references">Lifetime as memory references</a></h2>
<p>If you know <em>category theory</em>, you may heard of <em>duality</em>.
Just like <em>category theory</em>, the code region view also has its <em>DUAL</em> view:</p>
<blockquote>
<p>A lifetime refers to some memory or other resources and
constraint <code>'a: 'b</code> can also be read <code>'a</code> refers to a subset of <code>'b</code> or, if you like, <code>'a</code> in <code>'b</code>.</p>
</blockquote>
<p>In this dual view, if <code>'a</code> outlives <code>'b</code>, <code>'b</code> contains more resources than <code>'a</code> does.
I find this view is somehow complement to the region view.</p>
<p>Let's demonstrate this view with the following code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn use_longer() {
    let a: &amp;str = "a";     // 'a
    let b: &amp;str = "b";     // 'b
    let c: &amp;str = "c";     // 'c

    let d = longer(a, b);  // 'd
    let d = longer(c, d);  // 'e
}
<span class="boring">}</span></code></pre></pre>
<pre><code>'e -&gt; {
    'd -&gt; {
        'a,
        'b,
    },
    'c,
}
</code></pre>
<p>where arrow <code>-&gt;</code> means point to some resource and <code>{}</code> means union.
From this graph, we can easily conclude:</p>
<pre><code>'a: 'd
'b: 'd

'd: 'e
'c: 'e

'a: 'e
'b: 'e
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../journal/2024-08-11-03.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../journal/2024-08-11-01.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../journal/2024-08-11-03.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../journal/2024-08-11-01.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
