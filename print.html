<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Comcx&#x27;s secret base</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./src/assets/custom.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Comcx&#x27;s secret base</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<p><img src="./assets/icons8-best-terraria-48.png" alt="avatar" /></p>
<p>Hello, this is <em>Comcx</em> (or <em>Ireina</em>)<sup class="footnote-reference"><a href="#1">1</a></sup>.
I'm a programmer writing <em>Rust</em>, <em>C/C++</em>, <em>Java</em>, <em>Go</em> and <em>Haskell</em>.</p>
<p><a href="./journal/journal.html">Blog</a><sup class="footnote-reference"><a href="#2">2</a></sup><br />
<a href="https://github.com/ireina7">Github</a><br />
<a href="https://www.zhihu.com/people/comcx">Zhihu</a></p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><em>Ex falso quodlibet</em></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>🚧 for underwork(unfinished) state</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="blog"><a class="header" href="#blog">Blog</a></h1>
<p><a href="journal/?search=@tag(categories)"><code>categories</code></a>
<a href="journal/?search=@tag(programming)"><code>programming</code></a>
<a href="journal/?search=@tag(rust)"><code>rust</code></a>
<a href="journal/?search=@tag(math)"><code>math</code></a>
<a href="journal/?search=@tag(workout)"><code>workout</code></a>
<a href="journal/?search=@tag(linguistics)"><code>linguistics</code></a>
<a href="journal/?search=@tag(anime)"><code>anime</code></a>
<a href="journal/?search=@tag(work)"><code>work</code></a>
<a href="journal/?search=@tag(game)"><code>game</code></a></p>
<hr />
<p><em>2024/12</em></p>
<ul>
<li><a href="journal/./2024-12-08-01.html">Digimon exhibition</a></li>
</ul>
<p><em>2024/10</em></p>
<ul>
<li><a href="journal/./2024-10-26-02.html">Bash may swallow signals</a></li>
<li><a href="journal/./2024-10-26-01.html">Rusty docker setting</a></li>
</ul>
<p><em>2024/09</em></p>
<ul>
<li><a href="journal/./2024-09-01-01.html">Inside Tokio's <code>task_local!</code></a></li>
</ul>
<p><em>2024/08</em></p>
<ul>
<li>🚧 <a href="journal/./2024-08-22-02.html">Unravel <em>Tokio</em>'s <code>CurrentThread</code> runtime</a></li>
<li><a href="journal/./2024-08-22-01.html">Why the color of a function is our friend</a></li>
<li>🚧 <a href="journal/./2024-08-19-01.html">基于省略规则的轻量级英语语法系统</a></li>
<li><a href="journal/./2024-08-11-04.html"><em>Golang</em> does have sum types, however...</a></li>
<li>🚧 <a href="journal/./2024-08-11-03.html">Rewatch <em>Code Geass</em></a></li>
<li><a href="journal/./2024-08-11-02.html">Another view of Rust's lifetime</a></li>
<li><a href="journal/./2024-08-11-01.html">The two sides of programming languages</a></li>
<li><a href="journal/./2024-08-10-01.html">My programming key bindings</a></li>
<li><a href="journal/./2024-08-05-03.html">Polymorphism in Rust</a></li>
<li><a href="journal/./2024-08-05-02.html"><code>Relaxed</code> ordering and visibility</a></li>
<li><a href="journal/./2024-08-05-01.html">Golang is terrible as a general purpose language</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="digimon-exhibition"><a class="header" href="#digimon-exhibition">Digimon exhibition</a></h1>
<pre><code>@tag(anime)
</code></pre>
<p><img src="journal/../assets/digimon-2024/IMG_3701.jpg" alt="bus" /></p>
<p>今天看到了数码宝贝的展览，就顺道去参观了一下；整体办的内容有限（甚至有点简陋，电话亭居然不能用！），不过确实勾起了不少回忆。
似乎基本主要是90年代末左右的人会关注digimon，大概是因为那段时间电视上有播放吧。</p>
<p>整个展厅是顺着动画的剧情时间轴去布置的，每个展厅代表一个动画的篇章：
<img src="journal/../assets/digimon-2024/IMG_3700.jpg" alt="halls" /></p>
<p>一开始看到的是成长期的进化画面(巴鲁兽卖萌ing)
<img src="journal/../assets/digimon-2024/IMG_3655.jpg" alt="growing" />
还记得幼年期第一期进化的场景（虽然在悬崖边掉到了河里）。</p>
<p>在理解了数码宝贝世界基本的世界观之后，我们的小队很快遇到了恶魔兽。小时候觉得恶魔兽引诱孩子们进别墅的情节非常经典，其中有幅画似乎在暗示<em>天使与恶魔同在</em>。
<img src="journal/../assets/digimon-2024/IMG_3658.jpg" alt="devil" /></p>
<p>接下来我们就遇到了悟空兽，除了悟空兽的出场BGM之外，我印象最深的还是暴龙兽的错误进化，这也让太一第一次开始思考鲁莽与勇气之间的区别。
<img src="journal/../assets/digimon-2024/IMG_3660.jpg" alt="skeleton" /></p>
<p>除了恶魔，西方另一个经典的形象就是<em>吸血鬼</em>，所以接下来我们又遇到了吸血魔兽，某种意义上算是恶魔兽的加强版，也是这一段剧情了拓展了数码宝贝的世界观，发现数码世界是与现实世界相连的（这一设定十分超前，其中也深化了动画的主题，引入了家庭、父母、同龄人、虚拟与现实之间的关系探讨）：
<img src="journal/../assets/digimon-2024/IMG_3664.jpg" alt="vampire" /></p>
<p>可惜没有看到南瓜兽和矿石兽的万圣节之旅，我永远也忘不了这个情节。</p>
<p>正当我们以为打败吸血魔兽就可以恢复虚拟与现实之间的秩序之时，又出现了黑暗四天王，其中我印象最深的还是小丑皇，最绝望的时刻，只剩下希望：
<img src="journal/../assets/digimon-2024/IMG_3668.jpg" alt="joker" />
<img src="journal/../assets/digimon-2024/IMG_3663.jpg" alt="angel" /></p>
<p>最后的最后，实际上最终的boss是所有不幸的digimon的怨念，没有人为他们伸张权利，一切都是优胜劣汰的自然法则。到这里，伴着回到现实的列车和butterfly，我和主角小队们一同回到了现实。
<img src="journal/../assets/digimon-2024/IMG_3689.jpg" alt="back" /></p>
<p>临走的时候，发现还有战斗暴龙兽的雕像
<img src="journal/../assets/digimon-2024/IMG_3699.jpg" alt="fight" /></p>
<p>最后我买了一个盲盒，居然真的抽中了我编程的启蒙大佬光子郎：
<img src="journal/../assets/digimon-2024/IMG_3702.jpg" alt="program" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="bash-may-swallow-signals"><a class="header" href="#bash-may-swallow-signals">Bash may swallow signals</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>Recently I encountered a confusing bug:</p>
<blockquote>
<p>A simple <code>eprintln!</code> in Rust may cause panic!</p>
</blockquote>
<p>That sounds weird, right?
Let's check the <code>eprintln!</code>'s doc:</p>
<blockquote>
<p>Prints to the standard error, with a newline.</p>
<p>Equivalent to the <a href="crate::println"><code>println!</code></a> macro, except that output goes to
<a href="crate::io::stderr"><code>io::stderr</code></a> instead of <a href="crate::io::stdout"><code>io::stdout</code></a>. See <a href="crate::println"><code>println!</code></a> for
example usage.</p>
<p>Use <code>eprintln!</code> only for error and progress messages. Use <code>println!</code>
instead for the primary output of your program.</p>
<p>See <a href="journal/../std/fmt/index.html">the formatting documentation in <code>std::fmt</code></a>
for details of the macro argument syntax.</p>
<h1 id="panics"><a class="header" href="#panics">Panics</a></h1>
<p>Panics if writing to <code>io::stderr</code> fails.</p>
<p>Writing to non-blocking stderr can cause an error, which will lead
this macro to panic.</p>
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<pre><code>eprintln!("Error: Could not complete task");
</code></pre>
</blockquote>
<p>Therefore, at least we can conclude that print will only panic when the stderr cannot be written, but how?</p>
<h2 id="redirected-stderr"><a class="header" href="#redirected-stderr">Redirected stderr</a></h2>
<p>I checked the original stderr and It's normal. But quickly I noticed that the rust program's stderr was been redirected to another process's input.</p>
<p>Now the problem seems to be clear:</p>
<blockquote>
<p>The process which redireced Rust's program's stderr exits, then <code>eprintln!</code> writes to broken pipe and panic!</p>
</blockquote>
<p>But why? Why still write to stderr when something is broken?</p>
<h2 id="bash-launched-bash"><a class="header" href="#bash-launched-bash">Bash launched bash</a></h2>
<p>I noticed that the launch shell did not directly <code>exec</code> Rust program.
In stead, it call bash on another bash script which <code>exec</code> the real program.
For a minimal example:</p>
<pre><code class="language-sh"># launch.sh
bash run.sh

# run.sh
exec program
</code></pre>
<p>When we run the <code>launch.sh</code>:</p>
<pre><code class="language-sh">bash launch.sh
</code></pre>
<p>We create 2 processed: <code>bash lanuch.sh</code> and <code>program</code>.</p>
<p>It seems still fine. But if you try to <code>kill</code> the bash process, you can observe that, although the <code>bash</code> process is killed, the <code>program</code> process is still alive!</p>
<blockquote>
<p>BASH SWALLOWS SIGNALS!</p>
</blockquote>
<p>Now we completely unravel the reason:</p>
<blockquote>
<p>When the pod try to exit and kill process, it failed to kill the real process and leave it writing to broken pipes which leads to panic and coredumps.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="rusty-docker-setting"><a class="header" href="#rusty-docker-setting">Rusty docker setting</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>Recently I'm learning debugging and profiling tools of <em>Rust</em> on <em>Linux</em>.
I utilize docker to build a debian container and install various kinds of tools(e.g., LLDB, perf).
However, to use LLDB in docker container, there're some notices which one may need to care.</p>
<h2 id="lldb-python3-lib-path-problem"><a class="header" href="#lldb-python3-lib-path-problem">LLDB python3 lib path problem</a></h2>
<p>I install LLDB ion the official Rust image via:</p>
<pre><code class="language-sh">apt-get install lldb python3-lldb
</code></pre>
<p>But when I typed <code>rust-lldb</code>, I encountered the following error messages:</p>
<pre><code>ModuleNotFoundError: No module named ‘lldb.embedded_interpreter’ · Issue #55575 · llvm/llvm-project;
</code></pre>
<p>After quite some googling, I found this script useful:</p>
<pre><code class="language-sh">ln -s /usr/lib/llvm-14/lib/python3.11/dist-packages/lldb/* /usr/lib/python3/dist-packages/lldb/
</code></pre>
<p>Still, the version of python may vary on different lldb versions. Replace the actual version number if necessary.</p>
<h2 id="container-addtional-options"><a class="header" href="#container-addtional-options">Container addtional options</a></h2>
<p>When I thought "I have fixed the python3 problem and here we go!", another problem arises.
I just cannot use LLDB commands!</p>
<p>It turns out that I have to include some addtional options to enable debugging:</p>
<pre><code class="language-sh">docker run -dit --cap-add=SYS_PTRACE --security-opt seccomp=unconfined rust
</code></pre>
<p>Now LLDB is ready for debugging rust programs!</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="inside-tokios-task_local"><a class="header" href="#inside-tokios-task_local">Inside Tokio's <code>task_local!</code></a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>Recently I'm curious about Tokio runtime's <code>task_local</code> and <code>LocalKey</code>.
How can this macro ensure task-level global variable?</p>
<h2 id="task_local-is-based-on-thread_local"><a class="header" href="#task_local-is-based-on-thread_local"><code>task_local!</code> is based on <code>thread_local!</code></a></h2>
<p>Let's unravel <code>task_local</code> the macro's definition:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[macro_export]
#[cfg_attr(docsrs, doc(cfg(feature = "rt")))]
macro_rules! task_local {
     // empty (base case for the recursion)
    () =&gt; {};

    ($(#[$attr:meta])* $vis:vis static $name:ident: $t:ty; $($rest:tt)*) =&gt; {
        $crate::__task_local_inner!($(#[$attr])* $vis $name, $t);
        $crate::task_local!($($rest)*);
    };

    ($(#[$attr:meta])* $vis:vis static $name:ident: $t:ty) =&gt; {
        $crate::__task_local_inner!($(#[$attr])* $vis $name, $t);
    }
}

#[doc(hidden)]
#[macro_export]
macro_rules! __task_local_inner {
    ($(#[$attr:meta])* $vis:vis $name:ident, $t:ty) =&gt; {
        $(#[$attr])*
        $vis static $name: $crate::task::LocalKey&lt;$t&gt; = {
            std::thread_local! {
                static __KEY: std::cell::RefCell&lt;Option&lt;$t&gt;&gt; = const { std::cell::RefCell::new(None) };
            }

            $crate::task::LocalKey { inner: __KEY }
        };
    };
}
<span class="boring">}</span></code></pre></pre>
<p>where we can clearly conclude that <code>task_local!</code> is based on <code>thread_local!</code>.
However, threads are reused by multiple different tasks asynchronously.
If task 1 yields, the thread may be scheduled to another task 2.
When task 1 is ready to run again, it may select another thread 2 to poll.
Therefore, <code>thread_local</code> values may be overwritten or lost.</p>
<h2 id="swap"><a class="header" href="#swap">Swap!</a></h2>
<p>So, how does <code>task_local</code> ensure thread_local values not be overwritten or lost?
The secret is under the implementation of <code>Future</code> for <code>task::LocalKey</code>'s wrapper.</p>
<p>Firstly, to use a LocalKey, one need to <code>scope</code> it and produce a <code>TaskLocalFuture&lt;T, F&gt;</code>
which binds <code>T</code> and the corresponding task's future <code>F</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; LocalKey&lt;T&gt; {
    pub fn scope&lt;F&gt;(&amp;'static self, value: T, f: F) -&gt; TaskLocalFuture&lt;T, F&gt;
    where
        F: Future,
    {
        TaskLocalFuture {
            local: self,
            slot: Some(value),
            future: Some(f),
            _pinned: PhantomPinned,
        }
    }

    fn scope_inner&lt;F, R&gt;(&amp;'static self, slot: &amp;mut Option&lt;T&gt;, f: F) -&gt; Result&lt;R, ScopeInnerErr&gt;
    where
        F: FnOnce() -&gt; R,
    {
        struct Guard&lt;'a, T: 'static&gt; {
            local: &amp;'static LocalKey&lt;T&gt;,
            slot: &amp;'a mut Option&lt;T&gt;,
        }

        impl&lt;'a, T: 'static&gt; Drop for Guard&lt;'a, T&gt; {
            fn drop(&amp;mut self) {
                // This should not panic.
                //
                // We know that the RefCell was not borrowed before the call to
                // `scope_inner`, so the only way for this to panic is if the
                // closure has created but not destroyed a RefCell guard.
                // However, we never give user-code access to the guards, so
                // there's no way for user-code to forget to destroy a guard.
                //
                // The call to `with` also should not panic, since the
                // thread-local wasn't destroyed when we first called
                // `scope_inner`, and it shouldn't have gotten destroyed since
                // then.
                self.local.inner.with(|inner| {
                    let mut ref_mut = inner.borrow_mut();
                    mem::swap(self.slot, &amp;mut *ref_mut);
                });
            }
        }

        self.inner.try_with(|inner| {
            inner
                .try_borrow_mut()
                .map(|mut ref_mut| mem::swap(slot, &amp;mut *ref_mut))
        })??;

        let guard = Guard { local: self, slot };

        let res = f();

        drop(guard);

        Ok(res)
    }
}
<span class="boring">}</span></code></pre></pre>
<p>The value <code>T</code> is initialized when polled the first time.
The future impl is as follows:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T: 'static, F: Future&gt; Future for TaskLocalFuture&lt;T, F&gt; {
    type Output = F::Output;

    #[track_caller]
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        let this = self.project();
        let mut future_opt = this.future;

        let res = this
            .local
            .scope_inner(this.slot, || match future_opt.as_mut().as_pin_mut() {
                Some(fut) =&gt; {
                    let res = fut.poll(cx);
                    if res.is_ready() {
                        future_opt.set(None);
                    }
                    Some(res)
                }
                None =&gt; None,
            });

        match res {
            Ok(Some(res)) =&gt; res,
            Ok(None) =&gt; panic!("`TaskLocalFuture` polled after completion"),
            Err(err) =&gt; err.panic(),
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Whenever the future is used to poll again, it just <em>SWAP</em> the global <code>thread_local</code> slot and the value inside <code>TaskLocalFuture</code> and <em>SWAP</em> back when finished.</p>
<p>As easy as pie ;)</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="unravel-tokios-currentthread-runtime"><a class="header" href="#unravel-tokios-currentthread-runtime">Unravel <em>Tokio</em>'s <code>CurrentThread</code> runtime</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p><em>Tokio</em> provides nice async runtimes and async utilities.
I'm curious on its implemention of runtimes. Let's see its <code>CurrentThread</code> runtime first!</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<h2 id="spawn"><a class="header" href="#spawn">Spawn</a></h2>
<h2 id="worker"><a class="header" href="#worker">Worker</a></h2>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="why-the-color-of-a-function-is-our-friend"><a class="header" href="#why-the-color-of-a-function-is-our-friend">Why the color of a function is our friend</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>When talking about 'stackful coroutine <em>vs</em> stackless coroutine',
Some people claims that stackless coroutine's <em>async</em> color is infectious.
Once a function <code>await</code>s for async operations, it's <em>async</em> too.
Therefore <em>stackful coroutine</em> is better for managing complex coding.</p>
<p>This point is TOTALLY WRONG.</p>
<p>All colors, not only <em>async</em>, are all our friends!
They can help us manage complex structures of program.</p>
<h2 id="stackful-goroutine-without-color-is-not-that-good"><a class="header" href="#stackful-goroutine-without-color-is-not-that-good">Stackful goroutine without color is not that good</a></h2>
<p>Suppose a <em>Golang</em> function with the following signature:</p>
<pre><code class="language-go">func handle()
</code></pre>
<p>and now a new programmer Ireina joins the project and simply use the function in a blocking function <code>logic</code>:</p>
<pre><code class="language-go">func logic() {
    handle()
}
</code></pre>
<p>If function <code>handle</code> is a <em>non-blocking</em> call, then everything is ok.
However, if handle is a blocking call or can consume much time and Ireina didn't notice this,
<code>logic</code> may block the whole program. Even if <code>logic</code> cause no serious problem, another new programmer may create another function <code>logic2</code> calling <code>logic</code>, and <code>logic3</code> calling <code>logic2</code>, which wil eventually cause blocking problem.</p>
<p>Functions without color still need better document or comment to tell the caller how to use it and how to choose proper context to use it. Even worse, if some inner function may <em>panic</em>, it will destroy the whole calling chain!</p>
<p>How about channels as return type?</p>
<pre><code class="language-go">func handle() &lt;-chan string
</code></pre>
<p>This way is much much better! but in fact it is marking async effect now!
This is not about stackful coroutines, it's just about abstraction and constraints.</p>
<h2 id="async-should-be-marked-and-controled"><a class="header" href="#async-should-be-marked-and-controled">Async should be marked and controled</a></h2>
<p>Now suppose <code>handle</code> is marked as <code>async</code> in Rust:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn handle();

// or
fn handle() -&gt; impl Future&lt;Output=()&gt; + Send;
<span class="boring">}</span></code></pre></pre>
<p>Now Ireina only has 2 options of using it:</p>
<ul>
<li>Explicitly use a runtime to block on it until finished.</li>
<li>Mark <code>logic</code> as <code>async</code> too.</li>
</ul>
<p>She can never simply blocking on it without noticing.</p>
<blockquote>
<p>Colors can serve as a tool which indicate many <em>side-effect</em>s a function can cause.
Also, colors within a proper type system can prevent many potential bugs and performance issue.</p>
</blockquote>
<h2 id="color-of-effects"><a class="header" href="#color-of-effects">Color of <em>effects</em></a></h2>
<p>Beside <code>async</code>, there also exists many kinds of <em>effects</em>, such as <em>error handling</em>, <em>IO</em>, <em>optional</em>, <em>dependency injection</em>, etc. We can even compose these effects or even abstract over it to support various kinds of effects without changing code!</p>
<p>Embrace colors and effects!</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="基于省略规则的轻量级英语语法系统"><a class="header" href="#基于省略规则的轻量级英语语法系统">基于省略规则的轻量级英语语法系统</a></h1>
<pre><code>@tag(linguistics)
</code></pre>
<p>对于单纯的语言使用者而言，一门自然语言的语法其实并不是很重要，只有语言学者才会在意并尝试进行系统化。
但是在缺失语言环境的条件下，我们不得不了解语法来帮助我们快速联系并建立直觉和语感。
传统的英语语法往往会分门别类，对许多细节的严谨性也会导致最终总结的规则较为复杂；我认为其实自然语言并非类似数学或者编程语言那样的形式化语言，自然语言更接近一种符合直觉的，便于沟通而不断迭代演进的结果。因而我想阐述一种非常简化的基于省略系统的语法系统，帮助自己快速抓住英语语法中的直觉和思维习惯。</p>
<blockquote>
<p>本文会慢慢完善和补全，目前只是大概整理下思路</p>
</blockquote>
<h2 id="基本句式"><a class="header" href="#基本句式">基本句式</a></h2>
<p>传统语法倾向于至少将英语句式分为四种：主谓宾、主系表、主谓宾宾和主谓宾补。我认为其实只需要前两种就够了，后两种只是从句省略之后的结果。
由于从句省略会在后文集中阐述，这里我们简单记住英语主要有两种句式就可以了：</p>
<div class="table-wrapper"><table><thead><tr><th>结构</th><th>解释</th></tr></thead><tbody>
<tr><td>S + V + O</td><td>主谓宾</td></tr>
<tr><td>S + V + C</td><td>主系表（补语）</td></tr>
</tbody></table>
</div>
<p>其中，主谓宾中的宾语可能省略，因为动词本身就足够表达含义了。</p>
<h2 id="动词变形"><a class="header" href="#动词变形">动词变形</a></h2>
<p>英语与汉语相比，有几个不一样的地方：</p>
<ol>
<li>需要专门指定量词，比如<em>one</em>, <em>a</em>, <em>the</em>, 以及动词后加<code>s</code>。</li>
<li>需要将动词变形俩表达时间、语气、可能性等额外的信息。</li>
<li>对人称的表示存在宾格，人称会随出现的位置而变形。</li>
</ol>
<p>这里最重要的是第二点，这一点引出了英语语法的无数表达方式，即<strong>动状词</strong>（动词变形）。
作为谓语的动词部分，会由于不同使用的情景发生变化（单复数、时间、语气、不确定性，etc）。
举个例子：</p>
<blockquote>
<p>All men are created equal.</p>
</blockquote>
<p>传统的英语语法大概会告诉我们：<code>are created</code>作为谓语存在。另外我们还发现<code>create</code>这个词变成了过去分词，配合be动词来表达被动的含义。
这种动词的变化就是一种动词变形。这里我觉得其实将句型看作S+V+C更好一些，<code>created</code>是动词变形然后变成了一种形容词，有被动的含义。
这类动词变形主要包括：过去分词、现在分词、单复数。其中现在分词和动名词很像，只不过动名词可以当作名词或名词短语使用。</p>
<h3 id="助动词"><a class="header" href="#助动词">助动词</a></h3>
<p>除了动词本身的变化，经常我们还会发现动词可能和其它词一起构成谓语，比如<code>have</code>, <code>will</code>, <code>can</code>, <code>could</code>, <code>to</code>。
这类词中，一些词用来表示不确定的语气：</p>
<blockquote>
<p>He may be wrong.</p>
</blockquote>
<p>这里be动词前面使用了助动词<code>may</code>来表达不确定的语气，此外，<code>could</code>, <code>might</code>等也有不确定的语气。
而<code>will</code>则是主要用于表示某种意愿和未来的事情（比如用在将来时态中），
<code>have</code>用于过去完成时表示<em>已经完成</em>的含义，不定式<code>to do</code>其实可以看作带有助动词的从句省略（后文进一步阐述）。</p>
<h2 id="宾语和补语"><a class="header" href="#宾语和补语">宾语和补语</a></h2>
<p>看完动词，我们还需要稍微了解一下名词和形容词，这两类经常被用于宾语和补语中。</p>
<h2 id="从句"><a class="header" href="#从句">从句</a></h2>
<p>现在我们有了基本句式、动词变形以及助动词补足语气，接下来让我们开启任何语言都十分重要的部分：<strong>组合</strong>。
有了句子，自然会考虑如何将小句子组合成更大的句子，在编程语言中，我们有组合子；在英语中，我们有从句。</p>
<p>传统语法喜欢将从句进行分类：</p>
<ul>
<li>名词从句</li>
<li>副词从句</li>
<li>关系从句</li>
</ul>
<p>这种分类是ok的，我们就按照这个分类进行讨论。考虑这样两个句子：</p>
<blockquote>
<p>He said something.</p>
</blockquote>
<blockquote>
<p>He is a programmer.</p>
</blockquote>
<p>如果他说的内容就是第二句，即他想告诉我们他是个程序员，那么我们可以使用从句将这两句组合起来：</p>
<blockquote>
<p>He said that he is a programmer.</p>
</blockquote>
<p>副词从句经常使用<code>when</code>, <code>where</code>等表达时间、地点等额外的信息修饰句子。</p>
<h2 id="省略原则"><a class="header" href="#省略原则">省略原则</a></h2>
<p>自然语言往往会为了追求便捷性进行句子省略，同时显现出某种「言外之意」。
有趣的是，许许多多复杂的英语语法可以被归纳为从句省略：</p>
<ol>
<li>不定式是从句中有助动词时的一种省略</li>
<li>主谓宾补是从句为SVC结构时的一种省略</li>
<li>同位语也是SVC的一种省略表达</li>
</ol>
<p>省略的原则十分简单：</p>
<blockquote>
<p>省略从句中主语与 be 动词，只保留补语部分。</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="golang-does-have-sum-types-however"><a class="header" href="#golang-does-have-sum-types-however"><em>Golang</em> does have sum types, however...</a></h1>
<pre><code>@tag(programming)
</code></pre>
<blockquote>
<p>Golang has no sum type!</p>
</blockquote>
<p>People like to say that golang lacks <em>sum types</em>.
For example, in Rust we can write a simple <code>Result</code> type:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Result&lt;T, E&gt; {
    Ok(T),
    Err(E),
}
<span class="boring">}</span></code></pre></pre>
<p>Here <code>Result</code> is a sum type which can only be one variant(<code>Ok</code> or <code>Err</code>) but not both.
Sum types are really useful to constraint values. In category theory, sum type is dual to product type, which is a universal type. If product types can be written as <code>a * b</code>, then sum types can be written as <code>a + b</code>.</p>
<p>Golang lacks direct support on sum types, but we can still simulate it:</p>
<pre><code class="language-go">type result[T, E any] interface {
    isResult()
}

type Result[T, E any] struct {
    inner result[T, E]
}


type Ok[T, E any] struct {
    value T
}
type Err[T, E any] struct {
    err E
}

func (Ok[T, E]) isResult() {}
func (Err[T, E]) isResult() {}

func (res Result[T, E]) Switch() result[T, E] {
    return res.inner
}
</code></pre>
<p>To match variants:</p>
<pre><code class="language-golang">func matching[T, E any](res Result[T, E]) {
    switch r := res.Switch().(type) {
    case Ok[T, E]:
        _ = r.value
    case Err[T, E]:
    default:
    }
}
</code></pre>
<p>However, since golang doest not have generic methods, its function is still limited(golang team is far too conservative)...</p>
<p>Although we can simulate <code>Result</code> sum type in Golang, we are still forced to use (T, error) and write <code>if err != nil</code> lol. What a great language!</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="rewatch-code-geass"><a class="header" href="#rewatch-code-geass">Rewatch <em>Code Geass</em></a></h1>
<pre><code>@tag(anime)
</code></pre>
<p><em>Code Geass</em> is one of my favorite animes.
<img src="journal/../assets/code-geass-emperor-lelouch-vi-britannia.jpg" alt="emperor-lelouch" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="another-view-of-rusts-lifetime"><a class="header" href="#another-view-of-rusts-lifetime">Another view of Rust's lifetime</a></h1>
<pre><code>@tag(programming) @tag(rust)
</code></pre>
<p>Compared with <em>Haskell</em>, Rust is different for its effect system and ownership system.
Inside ownership system, lifetime plays an important role on borrowing and safety.
Traditionally, people think about lifetime as some region of code, which is a little kind of vague.
Why not try to see lifetime as a kind of memory(dependency) reference?</p>
<h2 id="lifetime-as-scope"><a class="header" href="#lifetime-as-scope">Lifetime as scope?</a></h2>
<p><em>The Rust book</em> suggests viewing lifetime as scopes. Consider a simple example:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let r;                // ---------+-- 'a
                          //          |
    {                     //          |
        let x = 5;        // -+-- 'b  |
        r = &amp;x;           //  |       |
    }                     // -+       |
                          //          |
    println!("r: {r}");   //          |
}                         // ---------+</code></pre></pre>
<p>Since <code>x</code>'s lifetime <code>'b</code> is shorter than <code>r</code>'s <code>'a</code>, we cannot assign <code>&amp;x</code> to <code>r</code>.
However, this reason is rather imprecise.
If we simply remove the last <code>println!</code> line, this code just compile fine.:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let r;                // ---------+-- 'a
                          //          |
    {                     //          |
        let x = 5;        // -+-- 'b  |
        r = &amp;x;           //  |       |
    }                     // -+       |
}                         // ---------+</code></pre></pre>
<p>Why?</p>
<p>Even worse, lifetime can contain <em>holes</em>, where it’s intermittently invalid between where it starts and where it ultimately ends. For example, let's change our previous code simply:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let i = 42;
    let mut r;                
    {
        let x = 5;        
        r = &amp;x;            // -------------+-- 'r
                           //              |
    }                      // -------------+

    r = &amp;i;                // -------------+-- 'r
    println!("r: {}", *r); //              |
}                          // -------------+</code></pre></pre>
<p>This time the code compiles. Surprise!
Why? why this code compiles fine?? If r's lifetime coprresponds to <code>x</code>'s reference, why <code>r</code> can br printed outside <code>x</code>'s scope now? There may exist holes in lifetime.</p>
<p>Apparently <em>scope</em> view is not correct. We need something better.</p>
<h2 id="lifetime-as-regions-of-code"><a class="header" href="#lifetime-as-regions-of-code">Lifetime as regions of code?</a></h2>
<p><em>Rustonomicon</em> the book suggests viewing lifetime as named regions of code.
Now our previous problems are solved, since <code>'r</code> spans only its valid data flow regions and the regions can contains arbitrary holes.</p>
<blockquote>
<p>Lifetime is named regions of code where the pointed data is valid.</p>
</blockquote>
<p>What about lifetime constraints like <code>'a: 'b</code>?</p>
<h2 id="lifetime-subtyping"><a class="header" href="#lifetime-subtyping">Lifetime subtyping</a></h2>
<p>Subtyping is really just a spectial relation just as other <em>trait</em>s can represent.
The only subtyping in rust is lifetime subtyping.</p>
<blockquote>
<p>if <code>'b</code> outlives <code>'a</code>, then <code>'b: 'a</code> and <code>&amp;'b T</code> is a subtype of <code>&amp;'a T</code>.</p>
</blockquote>
<p>Since <code>&amp;'b T</code> is a subtype of <code>&amp;'a T</code>, we can assign any <code>&amp;'b T</code> to <code>&amp;'a T</code>.
For example(again from <em>the rust book</em>):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn longer&lt;'a&gt;(s1: &amp;'a str, s2: &amp;'a str) -&gt; &amp;'a str {
    if s1.len() &gt; s2.len() {
        s1
    } else {
        s2
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Actually, this code cannot compile without lifetime subtyping. It's equivalent to this code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn longer&lt;'a, 'b, 'c&gt;(s1: &amp;'a str, s2: &amp;'b str) -&gt; &amp;'c str 
where
    'a: 'c,
    'b: 'c,
{
    if s1.len() &gt; s2.len() {
        s1
    } else {
        s2
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Automatic subtyping is only a fancy and convenient way to expression this relationship.</p>
<h2 id="lifetime-as-memory-references"><a class="header" href="#lifetime-as-memory-references">Lifetime as memory references</a></h2>
<p>If you know <em>category theory</em>, you may heard of <em>duality</em>.
Just like <em>category theory</em>, the code region view also has its <em>DUAL</em> view:</p>
<blockquote>
<p>A lifetime refers to some memory or other resources and
constraint <code>'a: 'b</code> can also be read <code>'a</code> refers to a subset of <code>'b</code> or, if you like, <code>'a</code> in <code>'b</code>.</p>
</blockquote>
<p>In this dual view, if <code>'a</code> outlives <code>'b</code>, <code>'b</code> contains more resources than <code>'a</code> does.
I find this view is somehow complement to the region view.</p>
<p>Let's demonstrate this view with the following code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn use_longer() {
    let a: &amp;str = "a";     // 'a
    let b: &amp;str = "b";     // 'b
    let c: &amp;str = "c";     // 'c

    let d = longer(a, b);  // 'd
    let d = longer(c, d);  // 'e
}
<span class="boring">}</span></code></pre></pre>
<pre><code>'e -&gt; {
    'd -&gt; {
        'a,
        'b,
    },
    'c,
}
</code></pre>
<p>where arrow <code>-&gt;</code> means point to some resource and <code>{}</code> means union.
From this graph, we can easily conclude:</p>
<pre><code>'a: 'd
'b: 'd

'd: 'e
'c: 'e

'a: 'e
'b: 'e
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="the-two-sides-of-programming-languages"><a class="header" href="#the-two-sides-of-programming-languages">The two sides of programming languages</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>Some people ask for programming languages worth learning.
I think almost all common languages worth a try, but I personally prefer two sides of programming languages.
You can imagine that there exists a balance whose left side represents <em>machine</em> and right represents <em>abstraction</em>.</p>
<h2 id="the-abstraction-side"><a class="header" href="#the-abstraction-side">The <strong>Abstraction</strong> side</a></h2>
<p>The <em>abstraction</em> side is the lost side in computer science classes.
To be precise, the <em>abstraction</em> is mainly about <em>Programming Language Theory(PLT)</em> and <em>Math</em>.</p>
<p>I still remember how enjoyful I was when I first the book <em>SICP</em>.
It uses <em>Scheme</em> the language to show you how programs are constructed from ground.
But <em>Scheme</em> lacks the world of static typing.
<em>Haskell</em> uses a different way to express types and side-effects.
It also introduce <em>Category theory</em> into programming, especially for <em>Monads</em> and <em>Functors</em>.
You can even learn more computaional models with more powerful typing system.
The Haskell's way of programming can lead you to the world of <em>dependent types</em> where types can depend on values.
I like the way <em>Lean4</em> uses to construct math proof and provide higher-level categorical structures.</p>
<h2 id="the-machine-side"><a class="header" href="#the-machine-side">The <strong>Machine</strong> side</a></h2>
<p>The <em>machine</em> side is the traditional side which almost all CS lessons focus on.
I think this side is so famous that you must known better than me.
Personally, I love <em>C</em> and <em>Rust</em> with some <em>assembly</em> codes.</p>
<h2 id="together"><a class="header" href="#together">Together</a></h2>
<p>The <em>Rust</em> language puts two sides together!
I love it so much.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="my-progamming-key-bindings"><a class="header" href="#my-progamming-key-bindings">My progamming key bindings</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>I like the idea of editing of <em>VIM</em>, but I still think this is not the best.
Some keys of <em>vscode</em>, <em>emacs</em> and particularly <em>Kakoune</em> ans <em>helix</em> are modern.</p>
<h2 id="general-idea"><a class="header" href="#general-idea">General idea</a></h2>
<p>Action follows selection.</p>
<h2 id="major-modes"><a class="header" href="#major-modes">Major modes</a></h2>
<ul>
<li><a href="journal/2024-08-10-01.html#normal-mode">Normal</a></li>
<li><a href="journal/2024-08-10-01.html#insert-mode">Insert</a></li>
<li><a href="journal/2024-08-10-01.html#picker-mode">Picker</a></li>
<li><a href="journal/2024-08-10-01.html#prompt-mode">Prompt</a></li>
<li><a href="journal/2024-08-10-01.html#popup-mode">Popup</a></li>
</ul>
<h2 id="minor-modes"><a class="header" href="#minor-modes">Minor modes</a></h2>
<ul>
<li><a href="journal/2024-08-10-01.html#view-mode">View</a></li>
<li><a href="journal/2024-08-10-01.html#select-mode">Select</a></li>
<li><a href="journal/2024-08-10-01.html#goto-mode">Goto</a></li>
<li><a href="journal/2024-08-10-01.html#match-mode">Match</a></li>
<li><a href="journal/2024-08-10-01.html#window-mode">Window</a></li>
<li><a href="journal/2024-08-10-01.html#space-mode">Space</a></li>
<li><a href="journal/2024-08-10-01.html#unimpaired">Unimpaired</a></li>
</ul>
<h2 id="keys"><a class="header" href="#keys">Keys</a></h2>
<h3 id="normal-mode"><a class="header" href="#normal-mode">Normal mode</a></h3>
<h4 id="movement"><a class="header" href="#movement">Movement</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>h</code>, <code>Left</code></td><td>Move left</td></tr>
<tr><td><code>j</code>, <code>Down</code></td><td>Move down</td></tr>
<tr><td><code>k</code>, <code>Up</code></td><td>Move up</td></tr>
<tr><td><code>l</code>, <code>Right</code></td><td>Move right</td></tr>
<tr><td><code>w</code></td><td>Move next word start</td></tr>
<tr><td><code>b</code></td><td>Move previous word start</td></tr>
<tr><td><code>e</code></td><td>Move next word end</td></tr>
<tr><td><code>f</code></td><td>Find next char</td></tr>
<tr><td><code>t</code></td><td>Find 'till next char</td></tr>
<tr><td><code>F</code></td><td>Find previous char</td></tr>
<tr><td><code>T</code></td><td>Find 'till previous char</td></tr>
<tr><td><code>Ctrl-b, PageUp</code></td><td>Move page up</td></tr>
<tr><td><code>Ctrl-f, PageDown</code></td><td>Move page down</td></tr>
<tr><td><code>Ctrl-u</code></td><td>Move cursor and page half page up</td></tr>
<tr><td><code>Ctrl-d</code></td><td>Move cursor and page half page down</td></tr>
<tr><td></td><td></td></tr>
<tr><td><code>0</code></td><td>Jump to the start of the line</td></tr>
<tr><td><code>^</code></td><td>Move to the first non-blank character of the line</td></tr>
<tr><td><code>$</code></td><td>Move cursor line end</td></tr>
<tr><td><code>G</code></td><td>Go to the last line of the document</td></tr>
<tr><td><code>Ctrl-o</code>, <code>Ctrl--</code></td><td>Go previous cursor location</td></tr>
<tr><td><code>Ctrl-i</code></td><td>Go next cursor location</td></tr>
</tbody></table>
</div>
<h4 id="changes"><a class="header" href="#changes">Changes</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>r</code></td><td>Replace with a character</td></tr>
<tr><td><code>R</code></td><td>Replace with yanked text</td></tr>
<tr><td><code>~</code></td><td>Switch case of the selected text</td></tr>
<tr><td><code>i</code></td><td>Insert before selection</td></tr>
<tr><td><code>a</code></td><td>Insert after selection (append)</td></tr>
<tr><td><code>I</code></td><td>Insert at the start of the line</td></tr>
<tr><td><code>A</code></td><td>Insert at the end of the line</td></tr>
<tr><td><code>o</code></td><td>Open new line below selection</td></tr>
<tr><td><code>O</code></td><td>Open new line above selection</td></tr>
<tr><td><code>u</code></td><td>Undo change</td></tr>
<tr><td><code>U</code></td><td>Redo change</td></tr>
<tr><td><code>y</code></td><td>Yank selection</td></tr>
<tr><td><code>p</code></td><td>Paste after selection</td></tr>
<tr><td><code>P</code></td><td>Paste before selection</td></tr>
<tr><td><code>"&lt;reg&gt;</code></td><td>Select a register to yank to or paste from</td></tr>
<tr><td><code>&gt;</code></td><td>Indent selection</td></tr>
<tr><td><code>&lt;</code></td><td>Unindent selection</td></tr>
<tr><td><code>=</code></td><td>Format selection (LSP)</td></tr>
<tr><td><code>d</code></td><td>Delete selection</td></tr>
<tr><td><code>c</code></td><td>Change selection (delete and enter insert mode)</td></tr>
<tr><td><code>Q</code></td><td>Start/stop macro recording to the selected register</td></tr>
<tr><td><code>q</code></td><td>Play back a recorded macro from the selected register</td></tr>
<tr><td><code>Alt-Up</code></td><td>Move line upward</td></tr>
<tr><td><code>Alt-Down</code></td><td>Move line downward</td></tr>
</tbody></table>
</div>
<h4 id="selection"><a class="header" href="#selection">Selection</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>s</code></td><td>Select all regex matches inside selections</td></tr>
<tr><td><code>C</code></td><td>Copy selection onto the next line (Add cursor below)</td></tr>
<tr><td><code>,</code></td><td>Keep only the primary selection</td></tr>
<tr><td><code>%</code>, <code>Cmd-a</code></td><td>Select entire file</td></tr>
<tr><td><code>x</code></td><td>Select current line, if already selected, extend to next line</td></tr>
</tbody></table>
</div>
<h4 id="searching"><a class="header" href="#searching">Searching</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>/</code></td><td>Search for regex pattern</td></tr>
<tr><td><code>?</code></td><td>Search for previous pattern</td></tr>
<tr><td><code>n</code></td><td>Select next search match</td></tr>
<tr><td><code>N</code></td><td>Select previous search match</td></tr>
<tr><td><code>*</code></td><td>Use current selection as the search pattern</td></tr>
</tbody></table>
</div>
<h4 id="file"><a class="header" href="#file">File</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>Cmd-s</code></td><td>Save current file</td></tr>
<tr><td><code>Cmd-n</code></td><td>Open new buffer</td></tr>
</tbody></table>
</div>
<h3 id="insert-mode"><a class="header" href="#insert-mode">Insert mode</a></h3>
<p>Press <code>i</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>Escape</code></td><td>Switch to normal mode</td></tr>
<tr><td><code>Ctrl-a</code></td><td>Goto line begin</td></tr>
<tr><td><code>Ctrl-e</code></td><td>Goto line end</td></tr>
<tr><td><code>Ctrl-d</code>, <code>Delete</code></td><td>Delete next char</td></tr>
<tr><td><code>Ctrl-j</code>, <code>Enter</code></td><td>Insert new line</td></tr>
<tr><td><code>Ctrl-x</code></td><td>Autocomplete</td></tr>
<tr><td><code>Alt-Delete</code></td><td>Delete word backward</td></tr>
<tr><td><code>Ctrl-u</code></td><td>Delete to start of line</td></tr>
<tr><td><code>Ctrl-k</code></td><td>Delete to end of line</td></tr>
</tbody></table>
</div>
<h3 id="picker-mode"><a class="header" href="#picker-mode">Picker mode</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>Shift-Tab</code>, <code>Up</code>, <code>Ctrl-p</code></td><td>Previous entry</td></tr>
<tr><td><code>Tab</code>, <code>Down</code>, <code>Ctrl-n</code></td><td>Next entry</td></tr>
<tr><td><code>PageUp</code>, <code>Ctrl-u</code></td><td>Page up</td></tr>
<tr><td><code>PageDown</code>, <code>Ctrl-d</code></td><td>Page down</td></tr>
<tr><td><code>Home</code></td><td>Go to first entry</td></tr>
<tr><td><code>End</code></td><td>Go to last entry</td></tr>
<tr><td><code>Enter</code></td><td>Open selected</td></tr>
<tr><td><code>Escape</code>, <code>Ctrl-c</code></td><td>Close picker</td></tr>
</tbody></table>
</div>
<h3 id="prompt-mode"><a class="header" href="#prompt-mode">Prompt mode</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>Escape</code>, <code>Ctrl-c</code></td><td>Close prompt</td></tr>
<tr><td><code>Alt-b</code>, <code>Ctrl-Left</code></td><td>Backward a word</td></tr>
<tr><td><code>Ctrl-f</code>, <code>Right</code></td><td>Forward a char</td></tr>
<tr><td><code>Ctrl-b</code>, <code>Left</code></td><td>Backward a char</td></tr>
<tr><td><code>Alt-f</code>, <code>Ctrl-Right</code></td><td>Forward a word</td></tr>
<tr><td><code>Ctrl-e</code>, <code>End</code></td><td>Move prompt end</td></tr>
<tr><td><code>Ctrl-a</code>, <code>Home</code></td><td>Move prompt start</td></tr>
<tr><td><code>Ctrl-w</code>, <code>Alt-Backspace</code>, <code>Ctrl-Backspace</code></td><td>Delete previous word</td></tr>
<tr><td><code>Alt-d</code>, <code>Alt-Delete</code>, <code>Ctrl-Delete</code></td><td>Delete next word</td></tr>
<tr><td><code>Ctrl-u</code></td><td>Delete to start of line</td></tr>
<tr><td><code>Ctrl-k</code></td><td>Delete to end of line</td></tr>
<tr><td><code>Backspace</code>, <code>Ctrl-h</code>, <code>Shift-Backspace</code></td><td>Delete previous char</td></tr>
<tr><td><code>Delete</code>, <code>Ctrl-d</code></td><td>Delete next char</td></tr>
<tr><td><code>Ctrl-p</code>, <code>Up</code></td><td>Select previous history</td></tr>
<tr><td><code>Ctrl-n</code>, <code>Down</code></td><td>Select next history</td></tr>
<tr><td><code>Tab</code></td><td>Select next completion item</td></tr>
<tr><td><code>Enter</code></td><td>Open selected</td></tr>
</tbody></table>
</div>
<h3 id="popup-mode"><a class="header" href="#popup-mode">Popup mode</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>Ctrl-u</code></td><td>Scroll up</td></tr>
<tr><td><code>Ctrl-d</code></td><td>Scroll down</td></tr>
</tbody></table>
</div>
<h3 id="view-mode"><a class="header" href="#view-mode">View mode</a></h3>
<p>Press <code>z</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>z</code>, <code>c</code></td><td>Vertically center the line</td></tr>
<tr><td><code>t</code></td><td>Align the line to the top of the screen</td></tr>
<tr><td><code>b</code></td><td>Align the line to the bottom of the screen</td></tr>
<tr><td><code>m</code>, <code>z</code></td><td>Align the line to the middle of the screen</td></tr>
<tr><td><code>j</code>, <code>down</code></td><td>Scroll the view downwards</td></tr>
<tr><td><code>k</code>, <code>up</code></td><td>Scroll the view upwards</td></tr>
<tr><td><code>Ctrl-f</code>, <code>PageDown</code></td><td>Move page down</td></tr>
<tr><td><code>Ctrl-b</code>, <code>PageUp</code></td><td>Move page up</td></tr>
<tr><td><code>Ctrl-u</code></td><td>Move cursor and page half page up</td></tr>
<tr><td><code>Ctrl-d</code></td><td>Move cursor and page half page down</td></tr>
</tbody></table>
</div>
<h3 id="select-mode"><a class="header" href="#select-mode">Select mode</a></h3>
<p>Press <code>v</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>;</code></td><td>Cancel selected region</td></tr>
</tbody></table>
</div>
<h3 id="goto-mode"><a class="header" href="#goto-mode">Goto mode</a></h3>
<p>Press <code>g</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>g</code></td><td>Go to line number <n> else start of file</td></tr>
<tr><td><code>e</code></td><td>Go to the end of the file</td></tr>
<tr><td><code>f</code></td><td>Go to files in the selections</td></tr>
<tr><td><code>h</code></td><td>Go to the start of the line</td></tr>
<tr><td><code>l</code></td><td>Go to the end of the line</td></tr>
<tr><td><code>s</code></td><td>Go to first non-whitespace character of the line</td></tr>
<tr><td><code>t</code></td><td>Go to the top of the screen</td></tr>
<tr><td><code>c</code></td><td>Go to the middle of the screen</td></tr>
<tr><td><code>b</code></td><td>Go to the bottom of the screen</td></tr>
<tr><td><code>d</code></td><td>Go to definition (LSP)</td></tr>
<tr><td><code>y</code></td><td>Go to type definition (LSP)</td></tr>
<tr><td><code>r</code></td><td>Go to references (LSP)</td></tr>
<tr><td><code>i</code></td><td>Go to implementation (LSP)</td></tr>
<tr><td><code>a</code></td><td>Go to the last accessed/alternate file</td></tr>
<tr><td><code>m</code></td><td>Go to the last modified/alternate file</td></tr>
<tr><td><code>n</code></td><td>Go to next buffer</td></tr>
<tr><td><code>p</code></td><td>Go to previous buffer</td></tr>
<tr><td><code>w</code></td><td>Show labels at each word and select the word that belongs to the entered labels</td></tr>
</tbody></table>
</div>
<h3 id="match-mode"><a class="header" href="#match-mode">Match mode</a></h3>
<p>Press <code>m</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>m</code></td><td>Goto matching bracket</td></tr>
<tr><td><code>s &lt;char&gt;</code></td><td>Surround current selection with <char></td></tr>
<tr><td><code>r &lt;from&gt;&lt;to&gt;</code></td><td>Replace surround character <from> with <to></td></tr>
<tr><td><code>d &lt;char&gt;</code></td><td>Delete surround character <char></td></tr>
<tr><td><code>a &lt;object&gt;</code></td><td>Select around textobject</td></tr>
<tr><td><code>i &lt;object&gt;</code></td><td>Select inside textobject</td></tr>
</tbody></table>
</div>
<h3 id="window-mode"><a class="header" href="#window-mode">Window mode</a></h3>
<p>Press <code>Ctrl-w</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>w</code>, <code>Ctrl-w</code></td><td>Switch to next window</td></tr>
<tr><td><code>v</code>, <code>Ctrl-v</code></td><td>Vertical right split</td></tr>
<tr><td><code>s</code>, <code>Ctrl-s</code></td><td>Horizontal bottom split</td></tr>
<tr><td><code>f</code></td><td>Go to files in the selections in horizontal splits</td></tr>
<tr><td><code>F</code></td><td>Go to files in the selections in vertical splits</td></tr>
<tr><td><code>h</code>, <code>Ctrl-h</code>, <code>Left</code></td><td>Move to left split</td></tr>
<tr><td><code>j</code>, <code>Ctrl-j</code>, <code>Down</code></td><td>Move to split below</td></tr>
<tr><td><code>k</code>, <code>Ctrl-k</code>, <code>Up</code></td><td>Move to split above</td></tr>
<tr><td><code>l</code>, <code>Ctrl-l</code>, <code>Right</code></td><td>Move to right split</td></tr>
<tr><td><code>q</code>, <code>Ctrl-q</code></td><td>Close current window</td></tr>
<tr><td><code>o</code>, <code>Ctrl-o</code></td><td>Only keep the current window, closing all the others</td></tr>
<tr><td><code>H</code></td><td>Swap window to the left</td></tr>
<tr><td><code>J</code></td><td>Swap window downwards</td></tr>
<tr><td><code>K</code></td><td>Swap window upwards</td></tr>
<tr><td><code>L</code></td><td>Swap window to the right</td></tr>
</tbody></table>
</div>
<h3 id="space-mode"><a class="header" href="#space-mode">Space mode</a></h3>
<p>Press <code>Space</code> in normal mode</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>f</code></td><td>Open file picker</td></tr>
<tr><td><code>F</code></td><td>Open file picker at current working directory</td></tr>
<tr><td><code>b</code></td><td>Open buffer picker</td></tr>
<tr><td><code>j</code></td><td>Open jumplist picker</td></tr>
<tr><td><code>k</code></td><td>Show documentation for item under cursor in a popup (LSP)</td></tr>
<tr><td><code>s</code></td><td>Open document symbol picker (LSP)</td></tr>
<tr><td><code>S</code></td><td>Open workspace symbol picker (LSP)</td></tr>
<tr><td><code>d</code></td><td>Open document diagnostics picker (LSP)</td></tr>
<tr><td><code>D</code></td><td>Open workspace diagnostics picker (LSP)</td></tr>
<tr><td><code>r</code></td><td>Rename symbol (LSP)</td></tr>
<tr><td><code>a</code></td><td>Apply code action (LSP)</td></tr>
<tr><td><code>h</code></td><td>Select symbol references (LSP)</td></tr>
<tr><td><code>c</code></td><td>Comment/uncomment selections</td></tr>
<tr><td><code>/</code></td><td>Global search in workspace folder</td></tr>
<tr><td><code>?</code></td><td>Open command palette</td></tr>
</tbody></table>
</div>
<h3 id="unimpaired"><a class="header" href="#unimpaired">Unimpaired</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Desc.</th></tr></thead><tbody>
<tr><td><code>]d</code></td><td>Go to next diagnostic (LSP)</td></tr>
<tr><td><code>[d</code></td><td>Go to previous diagnostic (LSP)</td></tr>
<tr><td><code>]D</code></td><td>Go to last diagnostic in document (LSP)</td></tr>
<tr><td><code>[D</code></td><td>Go to first diagnostic in document (LSP)</td></tr>
<tr><td><code>]f</code></td><td>Go to next function (TS)</td></tr>
<tr><td><code>[f</code></td><td>Go to previous function (TS)</td></tr>
<tr><td><code>]t</code></td><td>Go to next type definition (TS)</td></tr>
<tr><td><code>[t</code></td><td>Go to previous type definition (TS)</td></tr>
<tr><td><code>]a</code></td><td>Go to next argument/parameter (TS)</td></tr>
<tr><td><code>[a</code></td><td>Go to previous argument/parameter (TS)</td></tr>
<tr><td><code>]c</code></td><td>Go to next comment (TS)</td></tr>
<tr><td><code>[c</code></td><td>Go to previous comment (TS)</td></tr>
<tr><td><code>]T</code></td><td>Go to next test (TS)</td></tr>
<tr><td><code>[T</code></td><td>Go to previous test (TS)</td></tr>
<tr><td><code>]p</code></td><td>Go to next paragraph</td></tr>
<tr><td><code>[p</code></td><td>Go to previous paragraph</td></tr>
</tbody></table>
</div>
<h2 id="editors"><a class="header" href="#editors">Editors</a></h2>
<p>I current use <em>vscode</em> for its light-weight and extensions.
I use the extension <a href="https://marketplace.visualstudio.com/items?itemName=silverquark.dancehelix">Dance - Helix Alpha</a> and <a href="https://marketplace.visualstudio.com/items?itemName=shadowndacorner.vscode-easymotion">EasyMotion</a> to simulate Helix's key bindings.</p>
<p>Also, I add some key bindings:</p>
<pre><code class="language-json">// Place your key bindings in this file to override the defaultsauto[]
[
    {
        "key": "Escape",
        "command": "dance.modes.set.normal",
        "when": "editorTextFocus"
    },
    {
        "key": "ctrl+w",
        "command": "vscode-easymotion.jumpToWord",
        "when": "editorTextFocus &amp;&amp; dance.mode == 'insert'"
    },
    {
        "key": "=",
        "command": "editor.action.formatDocument",
        "when": "editorTextFocus &amp;&amp; dance.mode == 'normal'"    
    },
    {
        "key": "Ctrl+[",
        "command": "workbench.action.navigateBack",
        "when": "editorTextFocus &amp;&amp; dance.mode == 'normal'"
    },
    {
        "key": "Ctrl+]",
        "command": "workbench.action.navigateForward",
        "when": "editorTextFocus &amp;&amp; dance.mode == 'normal'"
    }
]
</code></pre>
<p>When using Vscode Vim plugin, I include the following settings:</p>
<pre><code class="language-json">{
    "vim.easymotion": true,
    "vim.incsearch": true,
    "vim.useSystemClipboard": true,
    "vim.useCtrlKeys": true,
    "vim.hlsearch": true,
    "vim.insertModeKeyBindings": [
        {
            "before": ["j", "j"],
            "after": ["&lt;Esc&gt;"]
        },
        {
            "before": ["&lt;C-j&gt;"],
            "commands": [
                "cursorDown"
            ]
        },
        {
            "before": ["C-k"],
            "commands": ["cursorUp"]
        },
        {
            "before": ["C-h"],
            "commands": ["cursorLeft"]
        },
        {
            "before": ["&lt;C-l&gt;"],
            "commands": ["cursorRight"]
        }
    ],
    "vim.normalModeKeyBindingsNonRecursive": [
        {
            "before": ["&lt;leader&gt;", "d"],
            "after": ["d", "d"]
        },
        {
            "before": ["&lt;C-n&gt;"],
            "commands": [":nohl"]
        },
        {
            "before": ["K"],
            "commands": ["lineBreakInsert"],
            "silent": true
        }
    ],
    "vim.leader": "&lt;space&gt;",
    "vim.handleKeys": {
        "&lt;C-a&gt;": false,
        "&lt;C-e&gt;": false,
        "&lt;C-f&gt;": false
    },
    
    "vim.smartRelativeLine": true,
    "vim.cursorStylePerMode.insert": "line-thin",
    "vim.cursorStylePerMode.normal": "block",
    "vim.normalModeKeyBindings": [
        {
            "before" : ["&lt;leader&gt;","w"],
            "commands" : [
                "workbench.action.switchWindow",
            ]
        },
        {
            "before" : ["&lt;leader&gt;","s"],
            "commands" : [
                "workbench.action.showAllSymbols",
            ]
        },
        {
            "before" : ["&lt;leader&gt;","f"],
            "commands" : [
                "workbench.action.quickOpen",
            ]
        },
        {
            "before" : ["&lt;leader&gt;","r"],
            "commands" : [
                "workbench.action.openRecent",
            ]
        },
        {
            "before" : ["&lt;leader&gt;","a"],
            "commands" : [
                "editor.action.quickFix",
            ]
        },
        {
            "before": ["&lt;leader&gt;", "p"],
            "commands": [
                "workbench.action.showCommands"
            ]
        },
        {
            "before": ["g", "r"],
            "commands": [
                "editor.action.goToReferences"
            ]
        },
        {
            "before": ["g", "i"],
            "commands": [
                "editor.action.goToImplementation"
            ]
        }
    ],
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="polymorphism-in-rust"><a class="header" href="#polymorphism-in-rust">Polymorphism in Rust</a></h1>
<pre><code>@tag(programming) @tag(rust)
</code></pre>
<p>Every language has polymorphism functions. Some utilize dynamic interfaces, some invent generics and typeclass to overload behavories.</p>
<p>Rust has <em>both</em>.</p>
<p>In Rust, we have type parameters and traits.
Rust really prefer generics over existential types. If one want to be <code>Debug</code>, just "generic" it:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn use_debug&lt;A: fmt::Debug&gt;(a: A);
<span class="boring">}</span></code></pre></pre>
<p>We also have <em>associated types</em>, <em>where clauses</em>, <em>impl types</em>, etc.
These all lift our type to polymorphism. However, there still exists two kinds of polymorphism which are somewhat hard to achieve in Rust now.</p>
<h2 id="effect-polymorphism"><a class="header" href="#effect-polymorphism">Effect polymorphism</a></h2>
<p>It's somewhat hard to explain what effect is because <em>side-effects</em> is nearly everywhere and we can't live without it!
Effects are everything except for function input/output. Think about errors, asynchrony, uncertainty. Think about it and try to guess what they correspond to in out daily programming.</p>
<p>Yes, they are <code>Result&lt;_&gt;</code>, <code>Future&lt;Output=_&gt;</code> and various kinds of containers. Now suppose you want to write some <code>fn</code> which performs some unknown effect:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn func&lt;F&gt;(x: i32) -&gt; F&lt;i32&gt;;
<span class="boring">}</span></code></pre></pre>
<p>Congratulations! we discovers <em>Higher-Kinded Types(HKT)</em>. But you may also have noticed that this is not enough since <code>Future</code> is a trait and we have no way of abstract traits. Apparently Rust does not like <em>Monads</em>. In Rust, abstracting effects is really really hard right now. If you want to write one API for both sync and async codes, I just suggest you to write two separate traits.</p>
<h2 id="ownership-polymorphism"><a class="header" href="#ownership-polymorphism">Ownership polymorphism</a></h2>
<p>Another one is ownership, which is also ubiquitous in Rust.
Suppose you want write some AST like:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Expr {
    Var(String),
    Call { f: Expr, args: Vec&lt;Expr&gt; },
    Lambda { args: Vec&lt;Expr&gt;, body: Expr }
}
<span class="boring">}</span></code></pre></pre>
<p>Apparently this does not compile since <code>Expr</code> is not <code>Sized</code>.
We have to add some ownership for every recurrent position. For example:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Expr {
    //...
    Call { f: Box&lt;Expr&gt;, /*..*/ }
    //...
}
<span class="boring">}</span></code></pre></pre>
<p>However, <code>Box</code> has exclusive ownership, what about <code>Rc</code> or even <code>Arc</code>?
You can just abstract the whole recurrent type as:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Expr&lt;This&gt; {
    Call { f: This, args: Vec&lt;This&gt; }
}

type Exprs = Expr&lt;Rc&lt;Expr&lt;???&gt;&gt;&gt;
<span class="boring">}</span></code></pre></pre>
<p><code>Expr</code> is a fixpoint! This way we now have infinite type.</p>
<p>How about just abstract HKT?</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Kind {
    type F&lt;T&gt;;
}

enum Expr&lt;K: Kind&gt; {
    Call { f: K::F&lt;Self&gt;, args: Vec&lt;K::F&lt;Self&gt;&gt; },
}
<span class="boring">}</span></code></pre></pre>
<p>HKTs are really useful on abstracting <code>* -&gt; *</code> types!</p>
<p>I believe in the future, we can have effect polymorphism with <code>Coroutine</code> one-shot algebraic effects and ownership polymorphism with <em>GAT</em> and <em>impl type</em> alias.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="relaxed-ordering-and-visibility"><a class="header" href="#relaxed-ordering-and-visibility"><code>Relaxed</code> ordering and visibility</a></h1>
<p>@tag(programming)</p>
<p>I'm really curious that whether the <em>relaxed</em> memory ordering can ensure to see
the last recent value in the total modification order. It appears that the C++ memory model alone is not enough.</p>
<p>The C++ memory model only states that</p>
<blockquote>
<p>Implementations should make atomic stores visible to atomic loads within a reasonable amount of time.</p>
</blockquote>
<p>which means in the code</p>
<pre><code class="language-c++">std::atomic&lt;int&gt; g{0};

// thread 1
g.store(42);

// thread 2
int a = g.load();
// do stuff with a
int b = g.load();
</code></pre>
<p>if thread 1 has executed the storing, thread 2 is not guaranteed to load 42 immediately.</p>
<p>However, C++ standard does ensure the visibility of <strong>RMW(Read-Modify-Write)</strong> operations as the standard says:</p>
<blockquote>
<p>Atomic read-modify-write operations shall always read the last value (in the modification order) written before the write associated with the read-modify-write operation.</p>
</blockquote>
<p>which means you don't need to worry about operations like <code>fetch_xx</code> and <code>compare_exchange</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="golang-is-terrible-as-a-general-purpose-language"><a class="header" href="#golang-is-terrible-as-a-general-purpose-language">Golang is terrible as a general purpose language</a></h1>
<pre><code>@tag(programming)
</code></pre>
<p>Golang is terrible at several things:</p>
<ol>
<li>
<p>Try to mix up <em>defaults</em>, <em>empty value</em>, <em>empty slice</em>, <em>null pointer</em> and <em>optional value</em>.
Function callers have to check all these things to avoid <strong>PANIC</strong>!
Also comparing nil values with poor type inference is really dirty.</p>
</li>
<li>
<p>Try to mix up sum type and product type.
Golang likes to simulate sum type with product types (e.g., return extra error), which is error-prone for several things:</p>
</li>
</ol>
<ul>
<li>Cannot ensure exclusive variant. You may receive both a return value and non-nil err.</li>
<li>You may also try to simulate sum type with interfaces, but interface is implicit and not sealed.</li>
</ul>
<ol start="3">
<li>
<p>Try to mix up dynamic and compile-time polymorphism.
Many APIs have to use <code>interface{}</code> and methods on receivers cannot have generic parameters.</p>
</li>
<li>
<p>Try to mix up <em>SHOULD implement</em> and <em>HAPPEN TO implement</em>.
Due to poor expressiveness of golang's type system, you may happens to implement some interfaces with wrong semantic.</p>
</li>
<li>
<p>Try to mix up directory hierarchy and module system.
You have to <code>mkdir</code> to create inner modules.</p>
</li>
</ol>
<p>Golang pros:</p>
<ol>
<li>Fast development with bugs.</li>
<li>Fast compiling time with little static check.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="h1"><a class="header" href="#h1">H1</a></h1>
<blockquote>
<p>这群在连云港过冬的蛎鹬本来依赖两个因放水而露出底部的鱼塘作为高潮栖息地，但是前段时间鱼塘又开始蓄水，让它们失去了合适的高潮地，潮水上涨时候只能像这样挤在鱼塘边的土质堤坝上，休息环境更差而且容易受人惊扰，实在是很可怜</p>
</blockquote>
<h2 id="h2"><a class="header" href="#h2">H2</a></h2>
<h3 id="h3"><a class="header" href="#h3">H3</a></h3>
<ul>
<li>1</li>
</ul>
<ol>
<li>2</li>
</ol>
<h2 id="font"><a class="header" href="#font">font</a></h2>
<p>testing: <code>code</code></p>
<p>testing: <em>italic</em></p>
<p>testing: <strong>bold</strong></p>
<h2 id="mathjax"><a class="header" href="#mathjax">mathjax</a></h2>
<p>\( \int x dx = \frac{x^2}{2} + C \)</p>
<p>\[ \mu = \frac{1}{N} \sum_{i=0} x_i \]</p>
<h2 id="katex"><a class="header" href="#katex">katex</a></h2>
<p>testing: inline formula: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3998em;vertical-align:-0.3558em;"></span><span class="mop"><span class="mop op-symbol small-op" style="margin-right:0.19445em;position:relative;top:-0.0006em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.044em;"><span style="top:-2.3442em;margin-left:-0.1945em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.2579em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3558em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></p>
<p>testing: block formula: <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.5219em;vertical-align:-0.9119em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.564em;"><span style="top:-1.7881em;margin-left:-0.4445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.8129em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9119em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6099em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.5699em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='2.48em' viewBox='0 0 400000 2592' preserveAspectRatio='xMinYMin slice'><path d='M424,2478 c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514 c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20 s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121 s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081 l0 -0c4,-6.7,10,-10,18,-10 H400000 v40H1014.6 s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185 c-2,6,-10,9,-24,9 c-8,0,-12,-0.7,-12,-2z M1001 80 h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lim</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>
<h2 id="code"><a class="header" href="#code">code</a></h2>
<pre><code class="language-cpp">#include __FILE__

template &lt;typename T, class C, int R&gt;
using T = C&lt;R&gt;;

static inline register void main(){
    auto f = main();
    int a = (long) (void*) &amp;f;
    f(a);

    return 1;
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
